<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чек-лист проверки организации противотуберкулезной помощи</title>
    <style>
        @font-face {
            font-family: 'Inter';
            src: url('./fonts/inter-cyrillic-400-normal.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Inter';
            src: url('./fonts/inter-cyrillic-500-normal.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Inter';
            src: url('./fonts/inter-cyrillic-600-normal.woff2') format('woff2');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Inter';
            src: url('./fonts/inter-cyrillic-700-normal.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        
        :root {
            --primary-color: #2c7fb8;
            --secondary-color: #7fcdbb;
            --light-color: #f0f9ff;
            --border-color: #ddd;
            --save-btn-bg: #ffc107;
            --save-btn-hover: #e0a800;
            --export-btn-bg: #28a745;
            --export-btn-hover: #218838;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .info-block {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .info-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-row label {
            font-weight: 600;
        }
        
        .info-row input, .info-row textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            background-color: white;
            font-family: 'Inter', sans-serif;
        }
        
        .info-row textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        @media (min-width: 769px) {
            .info-row-horizontal {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            .info-row-horizontal label {
                min-width: 200px;
            }
        }
        
        .timestamp {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        
        .timestamp label {
            font-weight: 600;
        }
        
        .timestamp input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
        }
        
        .auto-save-status {
            font-size: 0.9rem;
            color: #666;
            margin-left: 0;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .section.collapsed {
            max-height: 60px;
        }
        
        .section.expanded {
            max-height: 800px;
        }
        
        .section-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header h2 {
            margin: 0;
            font-size: 1.1rem;
            flex: 1;
            font-weight: 500;
        }
        
        .section-content {
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }
        
        .section.expanded .section-content {
            display: block;
        }
        
        .question {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid var(--secondary-color);
            background-color: #f9f9f9;
            transition: background-color 0.3s;
            position: relative;
        }
        
        .question-text {
            margin-bottom: 10px;
            font-weight: 500;
            font-size: 1rem;
            padding-right: 50px;
            line-height: 1.4;
        }
        
        .check-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .check-button.checked {
            background-color: #4CAF50;
            border-color: #4CAF50;
        }
        
        .check-button.checked::after {
            content: "✓";
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .check-button.checked-red {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .check-button.checked-red::after {
            content: "✓";
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .comment {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: none;
            min-height: 60px;
            font-size: 0.95rem;
            overflow: hidden;
            transition: height 0.2s;
            font-family: 'Inter', sans-serif;
        }
        
        .section-status {
            font-size: 0.8rem;
            background-color: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 10px;
            font-weight: 400;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 20px;
        }
        
        button {
            padding: 12px 30px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: opacity 0.3s;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        .save-btn {
            background-color: var(--save-btn-bg);
        }
        
        .save-btn:hover {
            background-color: var(--save-btn-hover);
        }
        
        .export-btn {
            background-color: var(--export-btn-bg);
        }
        
        .export-btn:hover {
            background-color: var(--export-btn-hover);
        }
        
        .clear-btn {
            background-color: #f44336;
        }
        
        .clear-btn:hover {
            background-color: #d32f2f;
        }

        .print-btn {
            background-color: #9c27b0;
        }
        
        .print-btn:hover {
            background-color: #7b1fa2;
        }

        @media print {
            body {
                background-color: white;
                padding: 5mm !important;
                margin: 0 !important;
                font-size: 10pt;
            }
            
            .container {
                box-shadow: none;
                padding: 0 !important;
                max-width: none !important;
                margin: 0 !important;
                width: 100% !important;
            }
            
            .controls, .progress-bar, .auto-save-status {
                display: none !important;
            }
            
            .section {
                max-height: none !important;
                margin-bottom: 10px !important;
                border: 1px solid #000 !important;
            }
            
            .section.collapsed {
                max-height: none !important;
            }
            
            .section-content {
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 8px !important;
            }
            
            .section-header {
                cursor: default;
                background-color: #2c7fb8 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 6px 8px !important;
                margin-bottom: 0 !important;
            }
            
            .section-header h2 {
                font-size: 11pt !important;
                margin: 0 !important;
            }
            
            .sections-grid {
                display: block !important;
                grid-template-columns: none !important;
                gap: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .question {
                margin-bottom: 8px !important;
                padding: 6px !important;
            }
            
            .question-text {
                font-size: 9pt !important;
                margin-bottom: 5px !important;
                padding-right: 35px !important;
            }
            
            .check-button {
                width: 20px !important;
                height: 20px !important;
                top: 6px !important;
                right: 6px !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .check-button.checked::after,
            .check-button.checked-red::after {
                font-size: 10px !important;
            }
            
            .comment {
                min-height: 40px !important;
                padding: 4px !important;
                font-size: 9pt !important;
                border: 1px solid #000 !important;
            }
            
            .section-status {
                display: none !important;
            }
            
            header {
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
            }
            
            h1 {
                font-size: 14pt !important;
                margin-bottom: 5px !important;
            }
            
            .info-block {
                padding: 8px !important;
                margin-bottom: 10px !important;
            }
            
            .info-row input, .info-row textarea {
                border: none !important;
                background: transparent !important;
                padding: 2px 0 !important;
            }
            
            .timestamp {
                padding: 8px !important;
                margin-bottom: 10px !important;
            }
            
            .timestamp input {
                padding: 4px !important;
                font-size: 10pt !important;
                border: 1px solid #000 !important;
                background: transparent !important;
            }
        }
        
        @media (max-width: 768px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header h2 {
                font-size: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Чек-лист проверки организации противотуберкулезной помощи</h1>
        </header>
        
        <div class="info-block">
            <div class="info-row">
                <label for="org-name">Проверяемая организация:</label>
                <input type="text" id="org-name" placeholder="Введите наименование учреждения">
            </div>
            
            <div class="info-row">
                <label for="inspector">Проверяющий (должность, ФИО):</label>
                <textarea id="inspector" placeholder="Введите должность и ФИО проверяющего" rows="2"></textarea>
            </div>
        </div>
        
        <div class="timestamp">
            <label for="timestamp">Дата проверки:</label>
            <input type="date" id="timestamp" name="timestamp">
            <div class="auto-save-status" id="auto-save-status">Автосохранение включено</div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        
        <div class="sections-grid" id="sections-container"></div>
        
        <div class="controls">
            <button id="save-btn" class="save-btn">Сохранить данные</button>
            <button id="export-btn" class="export-btn">Скачать Excel файл</button>
            <button id="clear-btn" class="clear-btn">Очистить форму</button>
            <button id="print-btn" class="print-btn">Печать формы</button>
        </div>
    </div>

    <script>
        (function() {
            // ---------- ДАННЫЕ ЧЕК-ЛИСТА (ПОЛНОСТЬЮ СОХРАНЕНЫ) ----------
            const sections = [
                {
                    title: "I. Документооборот и ведение медицинской карты (амбулаторная карта - АК)",
                    questions: [
                        "Наличие и заполнение картонной обложки (ф. 025/у)",
                        "Наличие подписанных информированных согласий на медицинское вмешательство",
                        "Заполнение «Карты больного туберкулезом» (ф. 1030) - внутренняя обложка",
                        "Заполнение всего рекомендованного типового блока шаблонов",
                        "Документы вклеены в хронологическом порядке (осмотры, эпикризы, протоколы ВК)",
                        "Результаты рентгенологических исследований подшиты друг на друга в отдельном разделе",
                        "Результаты лабораторных исследований (кровь, моча, МБТ) и ЭКГ подшиты в отдельной картонной обложке в конце АК",
                        "Копии направлений на госпитализацию не вклеиваются в АК (хранятся в пакетах)",
                        "Наличие направления от специалиста общей лечебной сети (ОЛС)",
                        "Наличие протокола ВК о постановке на диспансерный учет",
                        "Наличие записи о факте госпитализации (подтвержденная данными ЕМИАС)",
                        "Наличие ежемесячных кратких записей о нахождении пациента в стационаре",
                        "Наличие выписного эпикриза из стационара",
                        "Наличие этапного эпикриза после стационарного лечения (с планом ведения)",
                        "Наличие протоколов ВК/ЦВК о снятии с бациллярного учета, закрытии полости распада, переводе на фазу продолжения (ФП)",
                        "Наличие этапного эпикриза после перевода на ФП и после контрольных исследований (с планом ведения)",
                        "Наличие протокола ВК о завершении курса химиотерапии и переводе в группу ЗГДУ",
                        "Наличие протокола ВК о прекращении диспансерного наблюдения"
                    ]
                },
                {
                    title: "II. Диагностика и контроль пациентов",
                    questions: [
                        "Карты пациентов с неуточненным диагнозом (коробка №1) находятся в быстром доступе и проверяются ежедневно",
                        "Диагноз установлен в течение 14 дней с начала обследования",
                        "Карты пациентов с ожидаемыми отдаленными результатами (КТ-контроль, ППС и т.д.) хранятся отдельно (коробка №2)",
                        "В дневнике отражены все мероприятия по поиску и привлечению пациентов, прервавших лечение/дообследование",
                        "Лечащий врач уведомил заведующего отделением о пациентах, прервавших лечение",
                        "Данные о пациентах, прервавших лечение, внесены в журнал движения контингентов или отдельный список/журнал учета оторвавшихся",
                        "Пациенту вручены и разъяснены уведомления об обязательном обследовании или лечении, подписанные им",
                        "Проведены беседы с использованием наглядных материалов («Агит-папка»), показаны снимки КТ/рентгена",
                        "Для мотивации к хирургическому лечению использован QR-код с информацией для пациентов",
                        "При смене места жительства пациента подготовлено и направлено обращение в противотуберкулезную службу другого региона/Москвы",
                        "Копия обращения и ответ (при наличии) вклеены в АК",
                        "Диспансерное наблюдение прекращено только решением ВК после исчерпания мер поиска",
                        "Для пациентов 4-5 РХТ решение о прекращении наблюдения согласовано с заведующим филиалом",
                        "При наличии оснований (ст. 10 ФЗ-77) подготовлен полный пакет документов для суда/прокуратуры"
                    ]
                },
                {
                    title: "III. Лечение и мониторинг",
                    questions: [
                        "Все диагностические, лечебные и реабилитационные мероприятия назначены в строгом соответствии с актуальными клиническими рекомендациями",
                        "Частота и перечень контрольных исследований соответствуют клиническим рекомендациям",
                        "Используется памятка по мониторингу побочных реакций (НПР)",
                        "Препараты выдаются на срок до 10 дней",
                        "В день выдачи в бумажной АК сделана дневниковая запись (даты совпадают с журналом выдачи)",
                        "Пациент расписывается в журнале выдачи препаратов",
                        "Выдача осуществляется медсестрой на основании листа назначений",
                        "Организована сигнальная картотека с 32-мя разделителями для листов назначений",
                        "Листы неявившихся пациентов перемещены в соответствующую ячейку",
                        "Пациенту выдана памятка с схемой приема препаратов",
                        "Результаты консультации торакального хирурга отражены в системе «Барклай-стационар»",
                        "Участковый фтизиатр вносит данные о контроле и привлечении к хирургическому лечению в соответствующий раздел «Барклай»"
                    ]
                },
                {
                    title: "IV. Работа в очагах туберкулезной инфекции",
                    questions: [
                        "Для каждого контактного заведена ф. 025/у",
                        "Оформлены карта эпидобследования очага и карта участковой медсестры",
                        "Периодичность посещений очага соблюдена в соответствии с типом очага",
                        "В дневниковых записях карт медсестры и эпидемиолога фиксируются только повторные визиты",
                        "Выполнен полный план работы в очаге: определение границ, поиск контактов, санпросветработа, текущая дезинфекция, изоляция источника, заключительная дезинфекция, обследование контактов в течение 14 дней",
                        "Контактным лицам вручена памятка по текущей дезинфекции",
                        "Срок наблюдения за контактными лицами соблюден (в зависимости от статуса бактериовыделителя и возраста контакта)",
                        "Алгоритм работы с новорожденными в очаге соблюден (изоляция, БЦЖ, дезинфекция и пр.)",
                        "Направлено письмо работодателю о необходимости проведения противоэпидемических мероприятий",
                        "При выезде имеется распечатанная памятка с обоснованием (п.861 СанПиН)",
                        "Достигнуто понимание с администрацией о необходимости предоставить списки всех сотрудников, а не только непосредственных контактов",
                        "Получено предписание Роспотребнадзора до выхода в очаг (для мотивации работодателя)",
                        "Оформлена ф. №30 на очаг (с указанием места работы и данных пациента)",
                        "Ведутся списки сотрудников с отметками об обследовании",
                        "Акт выхода в очаг заверен печатью организации",
                        "Копия акта заключительной дезинфекции на производстве получена и зарегистрирована",
                        "Для эффективного информирования сотрудников распространена ссылка: https://ptdklin.github.io/diaskin/"
                    ]
                },
                {
                    title: "V. Взаимодействие с общей лечебной сетью (ОЛС) и раннее выявление",
                    questions: [
                        "Направлено письмо главному врачу ОЛС с просьбой обследовать контактных по подъезду/улице (без указания ФИО и номера квартиры пациента)",
                        "Получены от терапевтов списки жителей с датами предыдущей флюорографии",
                        "В случае позднего выявления направлено письмо главному врачу ЦРБ с требованием проведения разбора случая",
                        "Акт разбора случая позднего выявления хранится в пакете с документацией пациента",
                        "Составлен календарный план выходов в подразделения ОЛС на год (хранится в «Паспорте участка»)",
                        "После каждого посещения ОЛС составлен акт, подписанный руководителем поликлиники",
                        "Копия акта с отметкой о получении хранится, вторая копия направлена заведующему филиалом",
                        "Сформирован и распространен среди заведующих терапевтическими отделениями пакет документов по раннему выявлению (инфографика и нормативные акты, №144)"
                    ]
                },
                {
                    title: "VI. Организационные моменты и отчетность",
                    questions: [
                        "Включены все необходимые документы в Паспорт участка: описание территории, план работы с контингентами, план санпросветработы, план по Приказу 333-р, график выездов в ОЛС",
                        "Все документы хранятся вместе, используются шаблоны",
                        "Ведутся все обязательные журналы (список на стр. 8 руководства)",
                        "Ведется журнал движения контингентов как часть Паспорта участка",
                        "Перед отпуском или длительным отсутствием информация о пациентах передана коллегам в письменном виде"
                    ]
                },
                {
                    title: "VII. Алгоритм постановки на диспансерный учет (Чек-лист самоконтроля)",
                    questions: [
                        "Получено решение ВК о постановке на учет, запись внесена в журнал ВК (ф. 035/у)",
                        "Данные внесены в системы «Барклай» и ФРБТ",
                        "Поданы извещения в санэпиднадзор (ф. 089/у №147 и ф. 058/у №148)",
                        "Оформлено и вручено пациенту извещение об установлении диспансерного наблюдения, корешок сохранен",
                        "Обеспечена госпитализация пациента (при показаниях)",
                        "Оформлена «Карта больного туберкулезом» (ф. 1030) и типовой блок",
                        "Направлено письмо в ОЛС об обследовании контактных по подъезду",
                        "Получен список контактных от ОЛС",
                        "При позднем выявлении направлено письмо в ЦРБ о проведении разбора",
                        "Обследован бытовой очаг, оформлены карта эпидобследования и карта участковой медсестры",
                        "Направлено письмо работодателю для организации выхода в производственный очаг",
                        "Проведен выезд в производственный очаг, оформлен акт",
                        "Обследованы контактные лица в бытовом и производственном очагах",
                        "Данные пациента внесены в базу доноров",
                        "Получены акты о заключительной дезинфекции бытового и производственного очагов"
                    ]
                },
                {
                    title: "VIII. Ведение журналов",
                    questions: [
                        "Журнал выхода в очаг туберкулезной инфекции",
                        "Журнал движения контингентов",
                        "Журнал выдачи препаратов",
                        "Журнал постановки кожных проб",
                        "Журнал передачи сведений о проживающих в очаге туберкулёзной инфекции",
                        "Журнал учёта заключительной дезинфекции в очаге туберкулезной инфекции",
                        "Журнал регистрации извещений о постановке на учёт или прекращения наблюдения",
                        "Журнал консультаций торакального хирурга",
                        "Журнал учета клинико-экспертной работы лечебно-профилактического учреждения (ЭВН)",
                        "Журнал учета клинико-экспертной работы лечебно-профилактического учреждения (текущий лечебный контроль-ТЛК)",
                        "Журнал учета инфекционных заболеваний ф. N 060/у (печатная форма)"
                    ]
                }
            ];

            // ---------- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ----------
            let answers = {};                      // Хранилище ответов {sectionIndex: {questionIndex: {answer, comment}}}
            let totalQuestionsCount = 0;            // Общее количество вопросов (с учетом дополнительных)
            let answeredQuestionsCount = 0;         // Текущее количество отвеченных вопросов
            let autoSaveTimer = null;                // Таймер для debounce сохранения
            let lastSaveTime = null;                  // Время последнего сохранения
            let currentExpandedSection = null;        // Ссылка на текущую открытую секцию

            // ---------- ПРЕДВАРИТЕЛЬНЫЙ ПОДСЧЕТ ОБЩЕГО КОЛИЧЕСТВА ВОПРОСОВ ----------
            sections.forEach(section => {
                totalQuestionsCount += section.questions.length + 1; // +1 за "Дополнительная информация"
            });

            // ---------- ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ ----------
            document.addEventListener('DOMContentLoaded', function() {
                // Установка текущей даты
                const now = new Date();
                const timestampInput = document.getElementById('timestamp');
                timestampInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

                // Генерация скелета разделов (только заголовки)
                generateSectionSkeletons();

                // Загрузка данных из localStorage
                loadFromLocalStorage();

                // Обновление прогресс-бара на основе загруженных данных
                updateProgressBar();

                // Настройка обработчиков кнопок
                document.getElementById('save-btn').addEventListener('click', () => saveToLocalStorage(false));
                document.getElementById('clear-btn').addEventListener('click', clearForm);
                document.getElementById('print-btn').addEventListener('click', printForm);

                // Особый обработчик для кнопки экспорта (с ленивой загрузкой XLSX)
                document.getElementById('export-btn').addEventListener('click', lazyExportToExcel);

                // Автосохранение при закрытии страницы
                window.addEventListener('beforeunload', () => {
                    if (autoSaveTimer) {
                        clearTimeout(autoSaveTimer);
                    }
                    saveToLocalStorage(true);
                });

                // Периодическое автосохранение (раз в 3 минуты)
                setInterval(() => saveToLocalStorage(true), 3 * 60 * 1000);

                // Обновление статуса автосохранения
                updateAutoSaveStatus();
            });

            // ---------- ГЕНЕРАЦИЯ СКЕЛЕТА РАЗДЕЛОВ (ТОЛЬКО ЗАГОЛОВКИ) ----------
            function generateSectionSkeletons() {
                const container = document.getElementById('sections-container');

                sections.forEach((section, index) => {
                    const sectionElement = document.createElement('div');
                    sectionElement.className = 'section collapsed';
                    sectionElement.dataset.sectionIndex = index;

                    const header = document.createElement('div');
                    header.className = 'section-header';
                    header.dataset.sectionIndex = index;

                    const title = document.createElement('h2');
                    title.textContent = section.title;

                    const status = document.createElement('div');
                    status.className = 'section-status';
                    status.textContent = `0/${section.questions.length + 1}`;

                    header.appendChild(title);
                    header.appendChild(status);

                    const content = document.createElement('div');
                    content.className = 'section-content';

                    sectionElement.appendChild(header);
                    sectionElement.appendChild(content);
                    container.appendChild(sectionElement);

                    // Обработчик клика по заголовку с ленивой загрузкой контента
                    header.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const section = this.closest('.section');
                        const sectionIndex = section.dataset.sectionIndex;

                        // Ленивая загрузка вопросов, если секция еще не инициализирована
                        if (!section.dataset.initialized) {
                            lazyLoadSectionContent(section, parseInt(sectionIndex));
                            section.dataset.initialized = 'true';
                        }

                        // Управление сворачиванием/разворачиванием
                        toggleSection(section);
                    });
                });
            }

            // ---------- ЛЕНИВАЯ ЗАГРУЗКА КОНТЕНТА РАЗДЕЛА ----------
            function lazyLoadSectionContent(sectionElement, sectionIndex) {
                const contentElement = sectionElement.querySelector('.section-content');
                const sectionData = sections[sectionIndex];

                // Генерация всех вопросов раздела
                sectionData.questions.forEach((question, qIndex) => {
                    contentElement.appendChild(createQuestionElement(sectionIndex, qIndex, question));
                });

                // Добавление дополнительного вопроса
                contentElement.appendChild(createQuestionElement(sectionIndex, sectionData.questions.length, "Дополнительная информация"));

                // Восстановление сохраненных значений из answers
                restoreSectionFromAnswers(sectionIndex, contentElement);

                // Применение автосайза только к textarea этого раздела
                setupAutoResizeForSection(contentElement);
            }

            // ---------- СОЗДАНИЕ ЭЛЕМЕНТА ВОПРОСА (С УМНОЙ ЛОГИКОЙ СЧЕТЧИКА) ----------
            function createQuestionElement(sectionIndex, questionIndex, questionText) {
                const questionElement = document.createElement('div');
                questionElement.className = 'question';
                questionElement.dataset.questionId = `${sectionIndex}-${questionIndex}`;

                const questionTextElement = document.createElement('div');
                questionTextElement.className = 'question-text';
                questionTextElement.textContent = questionText;

                const checkButton = document.createElement('div');
                checkButton.className = 'check-button';
                checkButton.dataset.questionId = `${sectionIndex}-${questionIndex}`;

                questionElement.appendChild(questionTextElement);
                questionElement.appendChild(checkButton);

                const comment = document.createElement('textarea');
                comment.className = 'comment';
                comment.dataset.questionId = `${sectionIndex}-${questionIndex}`;
                comment.placeholder = 'Комментарий (при наличии замечаний)...';

                questionElement.appendChild(comment);

                // Состояние вопроса для отслеживания изменений счетчика
                let previousState = {
                    isChecked: false,
                    hasComment: false
                };

                // Функция обновления статуса и счетчика
                const updateState = (newChecked, newHasComment) => {
                    const wasChecked = previousState.isChecked;
                    const nowChecked = newChecked;

                    // Обновляем счетчик, только если изменилось само состояние "отвечен/не отвечен"
                    if (wasChecked !== nowChecked) {
                        if (nowChecked) {
                            answeredQuestionsCount++;
                        } else {
                            answeredQuestionsCount--;
                        }
                        updateProgressBar();
                    }

                    previousState = { isChecked: nowChecked, hasComment: newHasComment };
                };

                // Обработчик клика по галочке
                checkButton.addEventListener('click', function(e) {
                    e.stopPropagation();

                    const hasCommentText = comment.value.trim() !== '';

                    // Определяем новое состояние
                    if (hasCommentText) {
                        // Если есть комментарий - принудительно красная
                        this.classList.remove('checked');
                        this.classList.add('checked-red');
                    } else {
                        // Если нет комментария - переключаем между зеленой и пустой
                        if (this.classList.contains('checked')) {
                            this.classList.remove('checked');
                        } else {
                            this.classList.remove('checked-red');
                            this.classList.add('checked');
                        }
                    }

                    // Определяем, стал ли вопрос отвеченным
                    const isNowChecked = this.classList.contains('checked') || this.classList.contains('checked-red');
                    updateState(isNowChecked, hasCommentText);

                    // Сохраняем ответ
                    const answerStatus = isNowChecked ? 
                        (this.classList.contains('checked-red') ? 'Проверено (замечания)' : 'Проверено') : 
                        'Не проверено';
                    
                    saveAnswer(sectionIndex, questionIndex, answerStatus, comment.value);
                    updateSectionStatus(sectionIndex);
                    scheduleAutoSave();
                });

                // Обработчик ввода в комментарий
                comment.addEventListener('input', function() {
                    const hasCommentText = this.value.trim() !== '';
                    const checkBtn = questionElement.querySelector('.check-button');
                    const wasChecked = checkBtn.classList.contains('checked') || checkBtn.classList.contains('checked-red');

                    // Автоматическое обновление цвета галочки
                    if (hasCommentText) {
                        // Если есть комментарий - красная галочка (независимо от предыдущего состояния)
                        if (!checkBtn.classList.contains('checked-red')) {
                            checkBtn.classList.remove('checked');
                            checkBtn.classList.add('checked-red');
                        }
                    } else {
                        // Если комментарий пустой и была красная - убираем красную
                        if (checkBtn.classList.contains('checked-red')) {
                            checkBtn.classList.remove('checked-red');
                            // Если была зеленая - оставляем, если нет - ничего
                        }
                    }

                    // Определяем, изменилось ли состояние "отвечен/не отвечен"
                    const isNowChecked = checkBtn.classList.contains('checked') || checkBtn.classList.contains('checked-red');
                    
                    // Обновляем состояние и счетчик при необходимости
                    if (wasChecked !== isNowChecked) {
                        updateState(isNowChecked, hasCommentText);
                    } else {
                        // Состояние не изменилось, но нужно обновить previousState.hasComment
                        previousState.hasComment = hasCommentText;
                    }

                    // Сохраняем ответ
                    const answerStatus = isNowChecked ? 
                        (checkBtn.classList.contains('checked-red') ? 'Проверено (замечания)' : 'Проверено') : 
                        'Не проверено';
                    
                    saveAnswer(sectionIndex, questionIndex, answerStatus, this.value);
                    
                    // Автосайз
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                    
                    scheduleAutoSave();
                });

                return questionElement;
            }

            // ---------- УПРАВЛЕНИЕ РАЗДЕЛАМИ ----------
            function toggleSection(section) {
                const wasCollapsed = section.classList.contains('collapsed');

                // Закрываем предыдущую открытую секцию, если она есть и это не текущая
                if (currentExpandedSection && currentExpandedSection !== section) {
                    currentExpandedSection.classList.remove('expanded');
                    currentExpandedSection.classList.add('collapsed');
                }

                // Переключаем текущую секцию
                if (wasCollapsed) {
                    section.classList.remove('collapsed');
                    section.classList.add('expanded');
                    currentExpandedSection = section;
                    
                    // Простая прокрутка без smooth
                    setTimeout(() => {
                        section.scrollIntoView({ block: 'start' });
                    }, 50);
                } else {
                    section.classList.remove('expanded');
                    section.classList.add('collapsed');
                    if (currentExpandedSection === section) {
                        currentExpandedSection = null;
                    }
                }
            }

            // ---------- АВТОСАЙЗ ДЛЯ КОНКРЕТНОЙ СЕКЦИИ ----------
            function setupAutoResizeForSection(container) {
                container.querySelectorAll('.comment').forEach(textarea => {
                    textarea.style.height = 'auto';
                    textarea.style.height = (textarea.scrollHeight) + 'px';
                });
            }

            // ---------- СОХРАНЕНИЕ ОТВЕТА В ОБЪЕКТ ----------
            function saveAnswer(sectionIndex, questionIndex, answer, comment = null) {
                if (!answers[sectionIndex]) answers[sectionIndex] = {};
                answers[sectionIndex][questionIndex] = { answer, comment };
            }

            // ---------- ОБНОВЛЕНИЕ СТАТУСА РАЗДЕЛА ----------
            function updateSectionStatus(sectionIndex) {
                const section = document.querySelector(`.section[data-section-index="${sectionIndex}"]`);
                if (!section) return;
                
                const statusElement = section.querySelector('.section-status');
                const totalQuestions = sections[sectionIndex].questions.length + 1;
                const answeredQuestions = section.querySelectorAll('.check-button.checked, .check-button.checked-red').length;
                statusElement.textContent = `${answeredQuestions}/${totalQuestions}`;
            }

            // ---------- ОБНОВЛЕНИЕ ПРОГРЕСС-БАРА ----------
            function updateProgressBar() {
                const progressBar = document.getElementById('progress');
                const percent = (answeredQuestionsCount / totalQuestionsCount) * 100;
                progressBar.style.width = `${percent}%`;
            }

            // ---------- ВОССТАНОВЛЕНИЕ РАЗДЕЛА ИЗ СОХРАНЕННЫХ ОТВЕТОВ ----------
            function restoreSectionFromAnswers(sectionIndex, container) {
                if (!answers[sectionIndex]) return;

                Object.entries(answers[sectionIndex]).forEach(([qIndex, data]) => {
                    const questionElement = container.querySelector(`[data-question-id="${sectionIndex}-${qIndex}"]`);
                    if (!questionElement) return;

                    const checkButton = questionElement.querySelector('.check-button');
                    const commentArea = questionElement.querySelector('.comment');

                    if (data.answer === 'Проверено') {
                        checkButton.classList.add('checked');
                        answeredQuestionsCount++;
                    } else if (data.answer === 'Проверено (замечания)') {
                        checkButton.classList.add('checked-red');
                        answeredQuestionsCount++;
                    }

                    if (data.comment) {
                        commentArea.value = data.comment;
                        // Автоматически подгоняем высоту
                        commentArea.style.height = 'auto';
                        commentArea.style.height = (commentArea.scrollHeight) + 'px';
                    }
                });

                updateSectionStatus(sectionIndex);
            }

            // ---------- СОХРАНЕНИЕ В LOCALSTORAGE (DEBOUNCE) ----------
            function scheduleAutoSave() {
                if (autoSaveTimer) {
                    clearTimeout(autoSaveTimer);
                }
                autoSaveTimer = setTimeout(() => saveToLocalStorage(true), 2000);
            }

            function saveToLocalStorage(silent = true) {
                // Сбор данных из DOM (на случай, если какие-то секции не сохранялись через события)
                document.querySelectorAll('.section[data-initialized="true"]').forEach(section => {
                    const sectionIndex = section.dataset.sectionIndex;
                    section.querySelectorAll('.question').forEach(question => {
                        const questionId = question.dataset.questionId.split('-');
                        const qIndex = parseInt(questionId[1]);
                        const checkButton = question.querySelector('.check-button');
                        const comment = question.querySelector('.comment').value;

                        let answerStatus = 'Не проверено';
                        if (checkButton.classList.contains('checked')) answerStatus = 'Проверено';
                        else if (checkButton.classList.contains('checked-red')) answerStatus = 'Проверено (замечания)';

                        saveAnswer(parseInt(sectionIndex), qIndex, answerStatus, comment);
                    });
                });

                const data = {
                    timestamp: document.getElementById('timestamp').value,
                    orgName: document.getElementById('org-name').value,
                    inspector: document.getElementById('inspector').value,
                    answers: answers,
                    answeredCount: answeredQuestionsCount,
                    lastSaved: new Date().toLocaleString('ru-RU')
                };

                localStorage.setItem('tuberculosis_checklist_data', JSON.stringify(data));
                lastSaveTime = new Date();
                
                if (!silent) {
                    alert('Данные сохранены в браузере!');
                }
                
                updateAutoSaveStatus();
                autoSaveTimer = null;
            }

            // ---------- ЗАГРУЗКА ИЗ LOCALSTORAGE ----------
            function loadFromLocalStorage() {
                const savedData = localStorage.getItem('tuberculosis_checklist_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Восстанавливаем метаданные
                    if (data.timestamp) document.getElementById('timestamp').value = data.timestamp;
                    if (data.orgName) document.getElementById('org-name').value = data.orgName;
                    if (data.inspector) document.getElementById('inspector').value = data.inspector;
                    
                    // Восстанавливаем ответы
                    answers = data.answers || {};
                    
                    // Восстанавливаем счетчик отвеченных вопросов
                    answeredQuestionsCount = data.answeredCount || 0;
                    
                    // Статусы разделов обновятся при их ленивой загрузке
                    updateAutoSaveStatus();
                }
            }

            // ---------- ОБНОВЛЕНИЕ СТАТУСА АВТОСОХРАНЕНИЯ ----------
            function updateAutoSaveStatus() {
                const statusElement = document.getElementById('auto-save-status');
                if (lastSaveTime) {
                    const timeString = lastSaveTime.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                    statusElement.textContent = `Автосохранение: ${timeString}`;
                } else {
                    statusElement.textContent = 'Автосохранение включено';
                }
            }

            // ---------- ОЧИСТКА ФОРМЫ ----------
            function clearForm() {
                if (confirm('Вы уверены, что хотите очистить всю форму? Все данные будут удалены.')) {
                    // Очищаем данные
                    answers = {};
                    answeredQuestionsCount = 0;
                    localStorage.removeItem('tuberculosis_checklist_data');

                    // Очищаем инициализированные секции
                    document.querySelectorAll('.section[data-initialized="true"]').forEach(section => {
                        const content = section.querySelector('.section-content');
                        content.innerHTML = ''; // Удаляем все вопросы
                        delete section.dataset.initialized; // Сбрасываем флаг инициализации
                        
                        // Сбрасываем статус раздела
                        const sectionIndex = section.dataset.sectionIndex;
                        const statusElement = section.querySelector('.section-status');
                        statusElement.textContent = `0/${sections[sectionIndex].questions.length + 1}`;
                    });

                    // Очищаем поля ввода
                    document.getElementById('org-name').value = '';
                    document.getElementById('inspector').value = '';
                    
                    const now = new Date();
                    document.getElementById('timestamp').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;

                    // Обновляем прогресс-бар
                    updateProgressBar();
                    updateAutoSaveStatus();
                    
                    alert('Форма очищена!');
                }
            }

            // ---------- ПЕЧАТЬ ----------
            function printForm() {
                // Раскрываем все секции перед печатью
                document.querySelectorAll('.section').forEach(section => {
                    // Лениво загружаем все секции, если они еще не загружены
                    if (!section.dataset.initialized) {
                        const sectionIndex = section.dataset.sectionIndex;
                        lazyLoadSectionContent(section, parseInt(sectionIndex));
                        section.dataset.initialized = 'true';
                    }
                    
                    section.classList.remove('collapsed');
                    section.classList.add('expanded');
                });
                
                setTimeout(() => window.print(), 100);
            }

            // ---------- ЛЕНИВЫЙ ЭКСПОРТ В EXCEL (С ДОБАВЛЕНИЕМ СКРЫТОГО ЛИСТА С ПРОМПТОМ) ----------
async function lazyExportToExcel() {
    const exportBtn = document.getElementById('export-btn');
    const originalText = exportBtn.textContent;
    exportBtn.textContent = 'Загрузка...';
    exportBtn.disabled = true;

    try {
        // Динамическая загрузка XLSX
        if (!window.XLSX) {
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
        }

        // Подготовка данных
        const timestamp = document.getElementById('timestamp').value;
        const date = new Date(timestamp + 'T00:00:00').toLocaleDateString('ru-RU');
        const orgName = document.getElementById('org-name').value || 'Не указано';
        const inspector = document.getElementById('inspector').value || 'Не указано';

        // Убеждаемся, что все данные из DOM сохранены в answers
        document.querySelectorAll('.section[data-initialized="true"]').forEach(section => {
            const sectionIndex = section.dataset.sectionIndex;
            section.querySelectorAll('.question').forEach(question => {
                const questionId = question.dataset.questionId.split('-');
                const qIndex = parseInt(questionId[1]);
                const checkButton = question.querySelector('.check-button');
                const comment = question.querySelector('.comment').value;

                let answerStatus = 'Не проверено';
                if (checkButton.classList.contains('checked')) answerStatus = 'Проверено';
                else if (checkButton.classList.contains('checked-red')) answerStatus = 'Проверено (замечания)';

                saveAnswer(parseInt(sectionIndex), qIndex, answerStatus, comment);
            });
        });

        // СОЗДАЁМ НОВУЮ КНИГУ
        const wb = XLSX.utils.book_new();

        // === ЛИСТ 1: Чек-лист ===
        const checklistData = [
            ["Чек-лист проверки организации противотуберкулезной помощи"],
            [`Проверяемая организация: ${orgName}`],
            [`Проверяющий: ${inspector}`],
            [`Дата проверки: ${date}`],
            [],
            ["Раздел", "Вопрос", "Статус", "Комментарий"]
        ];

        sections.forEach((section, sectionIndex) => {
            checklistData.push([section.title, "", "", ""]);

            section.questions.forEach((question, questionIndex) => {
                const answerData = answers[sectionIndex]?.[questionIndex];
                checklistData.push(["", question, answerData?.answer || 'Не проверено', answerData?.comment || '']);
            });

            const additional = answers[sectionIndex]?.[section.questions.length];
            checklistData.push(["", "Дополнительная информация", additional?.answer || 'Не проверено', additional?.comment || '']);
            checklistData.push([]);
        });

        const wsChecklist = XLSX.utils.aoa_to_sheet(checklistData);
        wsChecklist['!cols'] = [{ wch: 20 }, { wch: 50 }, { wch: 15 }, { wch: 50 }];
        XLSX.utils.book_append_sheet(wb, wsChecklist, "Чек-лист ПТП");

        // === ЛИСТ 2: Промт для ИИ (СКРЫТЫЙ) ===
        const promptSheetData = createPromptSheet();
        const wsPrompt = XLSX.utils.aoa_to_sheet(promptSheetData);
        
        // Настройка ширины колонок для читаемости
        wsPrompt['!cols'] = [{ wch: 15 }, { wch: 100 }];
        
        // Добавляем лист в книгу
        XLSX.utils.book_append_sheet(wb, wsPrompt, "Промт для ИИ");
        
        // ДЕЛАЕМ ЛИСТ СКРЫТЫМ
        if (!wb.Workbook) wb.Workbook = { Sheets: [] };
        if (!wb.Workbook.Sheets) wb.Workbook.Sheets = [];
        
        // Находим индекс только что добавленного листа
        const sheetIndex = wb.SheetNames.length - 1;
        
        // Устанавливаем состояние скрытости
        wb.Workbook.Sheets[sheetIndex] = { Hidden: 1 }; // 0 - видимый, 1 - скрытый

        // === СОХРАНЯЕМ ФАЙЛ ===
        XLSX.writeFile(wb, `чек-лист_птп_${date.replace(/\./g, '-')}.xlsx`);

    } catch (error) {
        console.error('Ошибка при экспорте:', error);
        alert('Ошибка при экспорте: ' + error.message);
    } finally {
        exportBtn.textContent = originalText;
        exportBtn.disabled = false;
    }
}

// ---------- ФУНКЦИЯ ДЛЯ СОЗДАНИЯ ЛИСТА С ПРОМПТОМ ----------
function createPromptSheet() {
    // Получаем актуальные даты из формы
    const visitDateInput = document.getElementById('timestamp').value;
    const visitDate = visitDateInput ? new Date(visitDateInput + 'T00:00:00').toLocaleDateString('ru-RU') : '__________';
    
    // Текущая дата для составления акта
    const today = new Date();
    const reportDate = today.toLocaleDateString('ru-RU');
    
    // Полный текст промпта
    const promptText = `ПРОМПТ ДЛЯ ГЕНЕРАЦИИ АКТА КУРАТОРСКОГО ВИЗИТА

Ты — заведующий филиалом «Лесногорский» ГБУЗ МО «МОКПТД» Иванов Иван Иванович.

Составь акт кураторского визита сотрудников ГБУЗ МО «МОКПТД» в медицинскую организацию, имеющую в своей структуре противотуберкулезный кабинет (отделение), на примере ГБУЗ МО «Лесногорская больница».

Объект визита: противотуберкулезный кабинет (отделение) в структуре ГБУЗ МО «Лесногорская больница».

Дата проведения визита: ${visitDate}.
Дата составления акта: ${reportDate}.

Цель визита: Контроль организации противотуберкулезной помощи.

Данные об организации:
- Главный врач ГБУЗ МО «Лесногорская больница»: Петров Петр Петрович.
- При визите присутствовал: заместитель главного врача по амбулаторно-поликлинической помощи.

ВАЖНО: Если в исходных данных не указано, кто именно присутствовал со стороны больницы, используй универсальную рабочую фамилию — Никитин Никита Никитович, с должностью «заместитель главного врача по амбулаторно-поликлинической помощи». Это нужно, чтобы акт не остался с пропуском. Пользователь потом вручную исправит на реального сотрудника.

КАК РАБОТАТЬ С ЧЕК-ЛИСТОМ (ЭТО ВАЖНО):

В файле Excel есть столбцы: «Вопрос», «Статус», «Комментарий».

1. Статус «Не проверено» — полностью игнорируй эти строки. Не включай их в акт вообще.
2. Статус «Проверено» — означает, что в столбце «Комментарий» есть какой-то текст.
3. Твоя задача — проанализировать каждый комментарий и определить его характер:
   - Если комментарий описывает нарушение, недостаток, отсутствие чего-либо, несоответствие — это идет в раздел «Замечания и выявленные недостатки».
   - Если комментарий описывает позитивный факт, наличие документа, правильное действие, хорошую организацию — это идет в раздел «Положительные стороны работы».
   - Если комментарий нейтральный или информационный, отнеси его в замечания или в положительные, исходя из контекста.

ВАЖНЫЕ ТРЕБОВАНИЯ К АКТУ:

1. ТЕРМИНОЛОГИЯ:
   - Слово «проверка» не используется. Везде заменяй на: «кураторский визит», «осмотр», «анализ», «изучение».
   - Слова «нарушения» и «недостатки» — сохраняются, они уместны.
   - Все выводы и оценки должны относиться к работе **противотуберкулезного кабинета (отделения)**. Фразы про «администрацию больницы» используй только в исключительных случаях, если замечание действительно касается общебольничного уровня (например, отсутствие приказа, нехватка ставок). В остальном пиши: «в кабинете организовано...», «медицинским персоналом кабинета ведется...», «выявлены недостатки в работе кабинета...».

2. ЯЗЫК И СТИЛЬ:
   - Строгий официально-деловой стиль, но без эмоциональных оборотов.
   - Исключи фразы: «крайне тревожным фактом», «вызывает серьезную озабоченность», «вопиющее нарушение» и подобные.
   - Используй спокойные, деловые формулировки: «выявлено отсутствие», «установлено, что не ведется», «отмечается, что», «имеются упущения».
   - Никаких сухих списков — только связные абзацы, как в экспертном заключении.

3. СТРУКТУРА АКТА:
   - Шапка: дата составления, место составления, основание, цель визита.
   - Состав комиссии (председатель и члены).
   - Присутствовали: главный врач Петров П.П. и отдельной строкой — заместитель главного врача по амбулаторно-поликлинической помощи (если данных нет — Никитин Н.Н.).
   - Вводная часть: кратко — что именно изучалось.
     Формулировка: «Визитом, проведенным ${visitDate}, изучена организация противотуберкулезной помощи в противотуберкулезном кабинете ГБУЗ МО «Лесногорская больница», а именно: ведение медицинской документации, работа с контингентами больных туберкулезом, организация лечения и контроля, а также взаимодействие с общей лечебной сетью по раннему выявлению туберкулеза».
   - Раздел 1. Положительные стороны.
     Формулировки должны относиться к работе кабинета:
     - «В работе противотуберкулезного кабинета налажено...»
     - «Медицинским персоналом кабинета ведется...»
     - «Положительно оценивается организация...»
     - «Отмечается, что в кабинете...»
   - Раздел 2. Замечания и выявленные недостатки.
     Группируй замечания по темам (документооборот, работа с контингентами, санитарно-просветительная работа и т.д.), а не перечисляй построчно.
     Формулировки: «В ходе визита установлено, что...», «Выявлены нарушения в части...», «Отмечается, что...», «Имеются упущения в...», «Требует корректировки работа по...».
   - Раздел 3. Рекомендации и предложения комиссии.
     ⚠️ ВАЖНО: Рекомендации формулируются **без указания конкретных должностей**. Только действия:
     - «Организовать ведение журнала учета...»
     - «Обеспечить наличие картонных обложек...»
     - «Возобновить работу с коробкой №2...»
     - «Разработать порядок информирования...»
     - «Провести совещание с медицинским персоналом...»
     - «Активизировать санитарно-просветительную работу...»
     Исполнители определяются внутри организации самостоятельно.
   - Подписи и отметка об ознакомлении представителей больницы.

ПРИМЕРЫ ИНТЕРПРЕТАЦИИ КОММЕНТАРИЕВ:
- Комментарий: «Не ведется журнал выдачи препаратов» → Замечание.
- Комментарий: «Журнал выдачи препаратов ведется, но нерегулярно» → Замечание.
- Комментарий: «Все журналы ведутся аккуратно и в полном объеме» → Положительная сторона.
- Комментарий: «Картонные обложки оформлены не на всех пациентов» → Замечание.
- Комментарий: «Налажено взаимодействие с терапевтами, списки предоставляются ежемесячно» → Положительная сторона.`;

    // Преобразуем текст в формат для Excel (две колонки: "Параметр" и "Значение")
    const lines = promptText.split('\n');
    const sheetData = [["Параметр", "Значение"]];
    
    lines.forEach(line => {
        if (line.trim() === "") {
            sheetData.push(["", ""]);
        } else {
            sheetData.push(["", line]);
        }
    });
    
    return sheetData;
}

// ---------- ВСПОМОГАТЕЛЬНАЯ ФУНКЦИЯ ДЛЯ ЗАГРУЗКИ СКРИПТОВ ----------
function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

           

        })();
    </script>
</body>
</html>
